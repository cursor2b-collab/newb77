# 启用新游戏接口说明

## 问题排查

如果设置了 `VITE_USE_NEW_GAME_API=true` 但仍然使用旧接口，请按以下步骤排查：

### 1. 确认环境变量文件

确保在项目根目录有 `.env.local` 文件，内容为：

```env
VITE_USE_NEW_GAME_API=true
```

### 2. 重启开发服务器

**重要**: 修改 `.env.local` 文件后，必须重启 Vite 开发服务器才能生效！

```bash
# 停止当前服务器（Ctrl+C）
# 然后重新启动
npm run dev
# 或
yarn dev
```

### 3. 检查浏览器控制台

打开浏览器控制台（F12），查看是否有以下日志：

- `🔍 新游戏接口配置检查:` - 显示环境变量读取情况
- `🎮 使用新游戏接口获取游戏URL` - 表示正在使用新接口
- `ℹ️ 使用旧游戏接口（未启用新接口）` - 表示未启用新接口

### 4. 使用 localStorage 方式（临时方案）

如果环境变量不生效，可以在浏览器控制台执行：

```javascript
localStorage.setItem('use_new_game_api', 'true');
```

然后刷新页面。

### 5. 检查环境变量读取

在浏览器控制台执行：

```javascript
// 检查环境变量（需要在代码中打印）
console.log('VITE_USE_NEW_GAME_API:', import.meta.env.VITE_USE_NEW_GAME_API);
```

如果显示 `undefined`，说明环境变量未正确读取，需要重启开发服务器。

## 常见问题

### Q: 为什么设置了环境变量还是用旧接口？

A: 可能的原因：
1. **未重启开发服务器** - 修改 `.env.local` 后必须重启
2. **环境变量文件位置错误** - 必须在项目根目录
3. **环境变量名称错误** - 必须是 `VITE_USE_NEW_GAME_API`
4. **新接口调用失败** - 检查控制台错误日志

### Q: 如何确认新接口是否启用？

A: 查看浏览器控制台日志：
- 如果看到 `🎮 使用新游戏接口获取游戏URL`，说明已启用
- 如果看到 `ℹ️ 使用旧游戏接口（未启用新接口）`，说明未启用
- 如果看到 `🔄 回退到旧游戏接口`，说明新接口调用失败

### Q: 新接口调用失败怎么办？

A: 检查以下几点：
1. **用户是否已登录** - 新接口需要用户ID
2. **后端API是否正常** - 检查 `/api/game-api/*` 路由
3. **平台代码映射是否正确** - 检查 `mapApiCodeToVendorCode` 函数
4. **查看详细错误日志** - 控制台会显示 `❌ 新游戏接口调用失败:` 和详细错误信息

## 强制启用新接口（开发调试）

如果需要强制启用新接口进行测试，可以临时修改代码：

在 `src/lib/api/game.ts` 的 `shouldUseNewGameApi` 函数中，临时返回 `true`：

```typescript
const shouldUseNewGameApi = (): boolean => {
  // 临时强制启用
  return true;  // 临时添加这行
  
  // 原有逻辑...
};
```

**注意**: 测试完成后记得恢复原代码！

## 验证步骤

1. ✅ 确认 `.env.local` 文件存在且内容正确
2. ✅ 重启开发服务器
3. ✅ 打开浏览器控制台
4. ✅ 尝试打开游戏
5. ✅ 查看控制台日志，确认使用新接口

## 联系支持

如果问题仍未解决，请提供：
1. 浏览器控制台的完整日志
2. `.env.local` 文件内容
3. 是否已重启开发服务器
4. 新接口调用失败的详细错误信息
