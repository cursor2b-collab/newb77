# Supabaseéƒ¨ç½²å®Œæˆæ¸…å•

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. æ•°æ®åº“è¡¨åˆ›å»º
- âœ… `game_api_tokens` - Tokenå­˜å‚¨è¡¨
- âœ… `game_api_config` - é…ç½®è¡¨ï¼ˆå·²æ’å…¥4æ¡é»˜è®¤é…ç½®ï¼‰
- âœ… `game_api_logs` - APIæ—¥å¿—è¡¨

### 2. æ•°æ®åº“å‡½æ•°åˆ›å»º
- âœ… `get_valid_game_api_token()` - è·å–æœ‰æ•ˆToken
- âœ… `save_game_api_token()` - ä¿å­˜Token
- âœ… `cleanup_expired_tokens()` - æ¸…ç†è¿‡æœŸToken
- âœ… `check_rate_limit()` - é€Ÿç‡é™åˆ¶æ£€æŸ¥
- âœ… `log_api_call()` - è®°å½•APIè°ƒç”¨æ—¥å¿—

### 3. æ•°æ®åº“è§†å›¾åˆ›å»º
- âœ… `game_api_token_status` - TokençŠ¶æ€è§†å›¾
- âœ… `game_api_stats` - APIç»Ÿè®¡è§†å›¾

### 4. å®‰å…¨ç­–ç•¥ï¼ˆRLSï¼‰
- âœ… æ‰€æœ‰è¡¨å·²å¯ç”¨RLS
- âœ… Service Roleå¯ä»¥è®¿é—®æ‰€æœ‰æ•°æ®
- âœ… Anonymouså¯ä»¥è¯»å–é…ç½®å’Œæ’å…¥æ—¥å¿—

### 5. Edge Functionä»£ç æ›´æ–°
- âœ… ä½¿ç”¨æ•°æ®åº“å‡½æ•°ç®¡ç†Token
- âœ… é›†æˆé€Ÿç‡é™åˆ¶æ£€æŸ¥
- âœ… è‡ªåŠ¨è®°å½•APIè°ƒç”¨æ—¥å¿—

## ğŸ“‹ ä¸‹ä¸€æ­¥æ“ä½œ

### 1. è®¾ç½®ç¯å¢ƒå˜é‡

åœ¨Supabase Dashboardä¸­è®¾ç½®ä»¥ä¸‹ç¯å¢ƒå˜é‡ï¼š

1. è¿›å…¥é¡¹ç›®ï¼šhttps://supabase.com/dashboard/project/lfjvlypknjpheycqunyk
2. ç‚¹å‡» "Edge Functions" â†’ "Settings"
3. æ·»åŠ ä»¥ä¸‹Secretï¼š
   - `GAME_API_CLIENT_ID`: æ‚¨çš„ClientId
   - `GAME_API_CLIENT_SECRET`: æ‚¨çš„ClientSecret
   - `GAME_API_BASE_URL`: https://dcyqv8f2id.com/api/v2

æˆ–è€…ä½¿ç”¨CLIï¼š
```bash
supabase secrets set GAME_API_CLIENT_ID=your_client_id
supabase secrets set GAME_API_CLIENT_SECRET=your_client_secret
supabase secrets set GAME_API_BASE_URL=https://dcyqv8f2id.com/api/v2
```

### 2. éƒ¨ç½²Edge Function

```bash
cd tongmeng-main/supabase
supabase functions deploy game-api
```

### 3. æµ‹è¯•API

```bash
# æµ‹è¯•çŠ¶æ€ç«¯ç‚¹
curl https://lfjvlypknjpheycqunyk.supabase.co/functions/v1/game-api/status

# æµ‹è¯•è·å–ä¾›åº”å•†åˆ—è¡¨
curl https://lfjvlypknjpheycqunyk.supabase.co/functions/v1/game-api/vendors/list
```

## ğŸ” éªŒè¯æ•°æ®åº“

### æŸ¥çœ‹è¡¨ç»“æ„
```sql
SELECT table_name, column_name, data_type 
FROM information_schema.columns 
WHERE table_schema = 'public' 
AND table_name LIKE 'game_api%'
ORDER BY table_name, ordinal_position;
```

### æŸ¥çœ‹é…ç½®
```sql
SELECT * FROM game_api_config;
```

### æŸ¥çœ‹TokençŠ¶æ€
```sql
SELECT * FROM game_api_token_status;
```

### æŸ¥çœ‹APIç»Ÿè®¡
```sql
SELECT * FROM game_api_stats;
```

## ğŸ“Š ç›‘æ§å’Œç»´æŠ¤

### å®šæœŸæ¸…ç†è¿‡æœŸToken
```sql
SELECT cleanup_expired_tokens();
```

### æŸ¥çœ‹æœ€è¿‘çš„APIè°ƒç”¨
```sql
SELECT * FROM game_api_logs 
ORDER BY created_at DESC 
LIMIT 20;
```

### æŸ¥çœ‹é”™è¯¯æ—¥å¿—
```sql
SELECT * FROM game_api_logs 
WHERE status_code >= 400 
ORDER BY created_at DESC;
```

### æŸ¥çœ‹APIæ€§èƒ½ç»Ÿè®¡
```sql
SELECT 
  endpoint,
  AVG(execution_time_ms) as avg_time,
  MAX(execution_time_ms) as max_time,
  COUNT(*) as total_calls
FROM game_api_logs
GROUP BY endpoint
ORDER BY avg_time DESC;
```

## ğŸ¯ APIç«¯ç‚¹åˆ—è¡¨

éƒ¨ç½²åçš„APIåœ°å€æ ¼å¼ï¼š
```
https://lfjvlypknjpheycqunyk.supabase.co/functions/v1/game-api/{endpoint}
```

### å¯ç”¨ç«¯ç‚¹

| ç«¯ç‚¹ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| `/status` | GET | APIçŠ¶æ€æ£€æŸ¥ |
| `/vendors/list` | GET | è·å–ä¾›åº”å•†åˆ—è¡¨ |
| `/games/list` | POST | è·å–æ¸¸æˆåˆ—è¡¨ |
| `/games/mini/list` | GET | è·å–è¿·ä½ æ¸¸æˆåˆ—è¡¨ |
| `/game/detail` | POST | è·å–æ¸¸æˆè¯¦æƒ… |
| `/game/launch-url` | POST | è·å–å¯åŠ¨URL |
| `/user/create` | POST | åˆ›å»ºç”¨æˆ· |
| `/user/balance` | POST | è·å–ç”¨æˆ·ä½™é¢ |
| `/user/deposit` | POST | å­˜æ¬¾ |
| `/user/withdraw` | POST | ææ¬¾ |
| `/user/withdraw-all` | POST | å…¨éƒ¨ææ¬¾ |
| `/betting/history/by-date-v2` | POST | è·å–æŠ•æ³¨å†å²V2 |
| `/betting/history/by-id` | POST | è·å–æŠ•æ³¨å†å²ï¼ˆæŒ‰IDï¼‰ |
| `/betting/history/detail` | POST | è·å–æŠ•æ³¨è¯¦æƒ…URL |
| `/agent/balance` | GET | è·å–ä»£ç†ä½™é¢ |
| `/game/user/set-rtp` | POST | è®¾ç½®ç”¨æˆ·RTP |
| `/game/user/get-rtp` | POST | è·å–ç”¨æˆ·RTP |
| `/game/users/batch-rtp` | POST | æ‰¹é‡è®¾ç½®ç”¨æˆ·RTP |

## ğŸ” å®‰å…¨å»ºè®®

1. **å¯ç”¨JWTéªŒè¯**ï¼ˆå¯é€‰ä½†æ¨èï¼‰
   - ä¿®æ”¹Edge Functionæ·»åŠ JWTéªŒè¯
   - åªå…è®¸å·²è®¤è¯çš„ç”¨æˆ·è®¿é—®

2. **é™åˆ¶CORSæ¥æº**
   - ä¿®æ”¹CORSè®¾ç½®ï¼Œåªå…è®¸ç‰¹å®šåŸŸå

3. **å®šæœŸæ¸…ç†æ—¥å¿—**
   - å»ºè®®ä¿ç•™æœ€è¿‘30å¤©çš„æ—¥å¿—
   - å®šæœŸæ‰§è¡Œæ¸…ç†æ“ä½œ

4. **ç›‘æ§å¼‚å¸¸**
   - å®šæœŸæŸ¥çœ‹é”™è¯¯æ—¥å¿—
   - è®¾ç½®å‘Šè­¦ï¼ˆå¦‚æœä½¿ç”¨Supabase Proï¼‰

## ğŸ“ é¡¹ç›®ä¿¡æ¯

- **é¡¹ç›®ID**: lfjvlypknjpheycqunyk
- **é¡¹ç›®URL**: https://lfjvlypknjpheycqunyk.supabase.co
- **Edge Function URL**: https://lfjvlypknjpheycqunyk.supabase.co/functions/v1/game-api

## âœ¨ ç‰¹æ€§

- âœ… è‡ªåŠ¨Tokenç®¡ç†å’Œç¼“å­˜
- âœ… é€Ÿç‡é™åˆ¶ä¿æŠ¤
- âœ… å®Œæ•´çš„APIè°ƒç”¨æ—¥å¿—
- âœ… æ€§èƒ½ç›‘æ§å’Œç»Ÿè®¡
- âœ… è‡ªåŠ¨é”™è¯¯å¤„ç†
- âœ… CORSæ”¯æŒ

## ğŸ†˜ æ•…éšœæ’é™¤

### é—®é¢˜ï¼šTokenåˆ›å»ºå¤±è´¥
**è§£å†³**ï¼šæ£€æŸ¥ç¯å¢ƒå˜é‡æ˜¯å¦æ­£ç¡®è®¾ç½®

### é—®é¢˜ï¼šé€Ÿç‡é™åˆ¶é”™è¯¯
**è§£å†³**ï¼šç­‰å¾…æ—¶é—´çª—å£é‡ç½®ï¼Œæˆ–æ£€æŸ¥æ—¥å¿—äº†è§£é™åˆ¶æƒ…å†µ

### é—®é¢˜ï¼šæ•°æ®åº“è¿æ¥å¤±è´¥
**è§£å†³**ï¼šç¡®è®¤Supabaseé¡¹ç›®çŠ¶æ€æ­£å¸¸ï¼Œæ£€æŸ¥ç½‘ç»œè¿æ¥

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æ•°æ®åº“åˆ›å»ºæ€»ç»“](./æ•°æ®åº“åˆ›å»ºæ€»ç»“.md)
- [éƒ¨ç½²åˆ°SupabaseæŒ‡å—](./éƒ¨ç½²åˆ°SupabaseæŒ‡å—.md)
- [Edge Function README](./functions/game-api/README.md)
