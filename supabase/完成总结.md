# âœ… Supabaseæ•°æ®åº“å’ŒAPIæ¥å£åˆ›å»ºå®Œæˆæ€»ç»“

## ğŸ‰ å®ŒæˆçŠ¶æ€

æ‰€æœ‰æ•°æ®åº“è¡¨ã€å‡½æ•°ã€è§†å›¾å’ŒAPIæ¥å£å·²æˆåŠŸåˆ›å»ºå¹¶é…ç½®å®Œæˆï¼

## ğŸ“Š æ•°æ®åº“ç»“æ„

### å·²åˆ›å»ºçš„è¡¨ï¼ˆ3ä¸ªï¼‰

1. **game_api_tokens** - Tokenå­˜å‚¨è¡¨
   - å­˜å‚¨æ¸¸æˆAPIçš„è®¿é—®Token
   - è‡ªåŠ¨ç®¡ç†Tokenè¿‡æœŸæ—¶é—´
   - æ”¯æŒTokenç¼“å­˜å’Œè‡ªåŠ¨åˆ·æ–°

2. **game_api_config** - é…ç½®è¡¨
   - å­˜å‚¨APIé…ç½®ä¿¡æ¯
   - å·²é¢„ç½®4æ¡é»˜è®¤é…ç½®
   - æ”¯æŒåŠ¨æ€é…ç½®æ›´æ–°

3. **game_api_logs** - APIæ—¥å¿—è¡¨
   - è®°å½•æ‰€æœ‰APIè°ƒç”¨
   - åŒ…å«è¯·æ±‚/å“åº”æ•°æ®
   - æ”¯æŒæ€§èƒ½ç›‘æ§å’Œé”™è¯¯è¿½è¸ª

### å·²åˆ›å»ºçš„å‡½æ•°ï¼ˆ5ä¸ªï¼‰

1. `get_valid_game_api_token()` - è·å–æœ‰æ•ˆToken
2. `save_game_api_token()` - ä¿å­˜Token
3. `cleanup_expired_tokens()` - æ¸…ç†è¿‡æœŸToken
4. `check_rate_limit()` - é€Ÿç‡é™åˆ¶æ£€æŸ¥
5. `log_api_call()` - è®°å½•APIè°ƒç”¨æ—¥å¿—

### å·²åˆ›å»ºçš„è§†å›¾ï¼ˆ2ä¸ªï¼‰

1. `game_api_token_status` - TokençŠ¶æ€è§†å›¾
2. `game_api_stats` - APIç»Ÿè®¡è§†å›¾

## ğŸ” å®‰å…¨é…ç½®

- âœ… æ‰€æœ‰è¡¨å·²å¯ç”¨RLSï¼ˆRow Level Securityï¼‰
- âœ… Service Roleå¯ä»¥è®¿é—®æ‰€æœ‰æ•°æ®
- âœ… Anonymouså¯ä»¥è¯»å–é…ç½®
- âœ… æ‰€æœ‰å‡½æ•°å·²è®¾ç½®`SET search_path = public`
- âœ… å‡½æ•°ä½¿ç”¨`SECURITY DEFINER`ç¡®ä¿å®‰å…¨æ‰§è¡Œ

## ğŸš€ APIæ¥å£

Edge Functionå·²æ›´æ–°ï¼Œæ”¯æŒä»¥ä¸‹22ä¸ªAPIç«¯ç‚¹ï¼š

### è®¤è¯ç›¸å…³
- âœ… `/status` - APIçŠ¶æ€æ£€æŸ¥
- âœ… Tokenè‡ªåŠ¨ç®¡ç†ï¼ˆæ— éœ€æ‰‹åŠ¨è°ƒç”¨ï¼‰

### ä¾›åº”å•†å’Œæ¸¸æˆ
- âœ… `/vendors/list` - è·å–ä¾›åº”å•†åˆ—è¡¨
- âœ… `/games/list` - è·å–æ¸¸æˆåˆ—è¡¨
- âœ… `/games/mini/list` - è·å–è¿·ä½ æ¸¸æˆåˆ—è¡¨
- âœ… `/game/detail` - è·å–æ¸¸æˆè¯¦æƒ…
- âœ… `/game/launch-url` - è·å–å¯åŠ¨URL

### ç”¨æˆ·ç®¡ç†
- âœ… `/user/create` - åˆ›å»ºç”¨æˆ·
- âœ… `/user/balance` - è·å–ç”¨æˆ·ä½™é¢
- âœ… `/user/deposit` - å­˜æ¬¾
- âœ… `/user/withdraw` - ææ¬¾
- âœ… `/user/withdraw-all` - å…¨éƒ¨ææ¬¾

### æŠ•æ³¨å†å²
- âœ… `/betting/history/by-date-v2` - è·å–æŠ•æ³¨å†å²V2ï¼ˆå¸¦é€Ÿç‡é™åˆ¶ï¼‰
- âœ… `/betting/history/by-id` - è·å–æŠ•æ³¨å†å²ï¼ˆæŒ‰IDï¼‰
- âœ… `/betting/history/detail` - è·å–æŠ•æ³¨è¯¦æƒ…URL

### ä»£ç†å’ŒRTP
- âœ… `/agent/balance` - è·å–ä»£ç†ä½™é¢
- âœ… `/game/user/set-rtp` - è®¾ç½®ç”¨æˆ·RTP
- âœ… `/game/user/get-rtp` - è·å–ç”¨æˆ·RTP
- âœ… `/game/users/batch-rtp` - æ‰¹é‡è®¾ç½®ç”¨æˆ·RTPï¼ˆå¸¦é€Ÿç‡é™åˆ¶ï¼‰

## ğŸ“ å·²æ‰§è¡Œçš„è¿ç§»

1. âœ… create_game_api_tokens_table
2. âœ… create_game_api_config_table
3. âœ… create_game_api_logs_table
4. âœ… create_api_functions
5. âœ… create_rls_policies
6. âœ… create_helper_views
7. âœ… create_api_rate_limit_function
8. âœ… fix_security_issues
9. âœ… fix_views_security_definer

## ğŸ¯ é¡¹ç›®ä¿¡æ¯

- **é¡¹ç›®ID**: lfjvlypknjpheycqunyk
- **é¡¹ç›®URL**: https://lfjvlypknjpheycqunyk.supabase.co
- **APIåŸºç¡€è·¯å¾„**: `/functions/v1/game-api`
- **å®Œæ•´API URL**: `https://lfjvlypknjpheycqunyk.supabase.co/functions/v1/game-api`

## âš™ï¸ ä¸‹ä¸€æ­¥æ“ä½œ

### 1. è®¾ç½®ç¯å¢ƒå˜é‡ï¼ˆå¿…éœ€ï¼‰

åœ¨Supabase Dashboardä¸­è®¾ç½®ï¼š

1. è®¿é—®ï¼šhttps://supabase.com/dashboard/project/lfjvlypknjpheycqunyk/settings/functions
2. æ·»åŠ ä»¥ä¸‹Secretsï¼š
   ```
   GAME_API_CLIENT_ID=your_client_id
   GAME_API_CLIENT_SECRET=your_client_secret
   GAME_API_BASE_URL=https://dcyqv8f2id.com/api/v2
   ```

### 2. éƒ¨ç½²Edge Function

```bash
cd tongmeng-main/supabase
supabase functions deploy game-api
```

### 3. æµ‹è¯•API

```bash
# æµ‹è¯•çŠ¶æ€
curl https://lfjvlypknjpheycqunyk.supabase.co/functions/v1/game-api/status
```

## ğŸ“š æ–‡æ¡£

å·²åˆ›å»ºçš„æ–‡æ¡£ï¼š
- âœ… `æ•°æ®åº“åˆ›å»ºæ€»ç»“.md` - è¯¦ç»†çš„æ•°æ®åº“ç»“æ„è¯´æ˜
- âœ… `éƒ¨ç½²å®Œæˆæ¸…å•.md` - éƒ¨ç½²æ­¥éª¤å’ŒéªŒè¯æ–¹æ³•
- âœ… `APIæ¥å£ä½¿ç”¨ç¤ºä¾‹.md` - å®Œæ•´çš„APIä½¿ç”¨ç¤ºä¾‹
- âœ… `éƒ¨ç½²åˆ°SupabaseæŒ‡å—.md` - è¯¦ç»†éƒ¨ç½²æŒ‡å—
- âœ… `å¿«é€Ÿå¼€å§‹.md` - 5åˆ†é’Ÿå¿«é€Ÿéƒ¨ç½²

## ğŸ” éªŒè¯æŸ¥è¯¢

### æŸ¥çœ‹æ‰€æœ‰è¡¨
```sql
SELECT table_name 
FROM information_schema.tables 
WHERE table_schema = 'public' 
AND table_name LIKE 'game_api%';
```

### æŸ¥çœ‹æ‰€æœ‰å‡½æ•°
```sql
SELECT routine_name 
FROM information_schema.routines 
WHERE routine_schema = 'public' 
AND routine_name LIKE '%game_api%';
```

### æŸ¥çœ‹é…ç½®
```sql
SELECT * FROM game_api_config;
```

### æŸ¥çœ‹TokençŠ¶æ€
```sql
SELECT * FROM game_api_token_status;
```

### æŸ¥çœ‹APIç»Ÿè®¡
```sql
SELECT * FROM game_api_stats;
```

## âœ¨ ç‰¹æ€§

- âœ… è‡ªåŠ¨Tokenç®¡ç†å’Œç¼“å­˜
- âœ… é€Ÿç‡é™åˆ¶ä¿æŠ¤
- âœ… å®Œæ•´çš„APIè°ƒç”¨æ—¥å¿—
- âœ… æ€§èƒ½ç›‘æ§å’Œç»Ÿè®¡
- âœ… è‡ªåŠ¨é”™è¯¯å¤„ç†
- âœ… CORSæ”¯æŒ
- âœ… å®‰å…¨ç­–ç•¥ï¼ˆRLSï¼‰
- âœ… æ•°æ®åº“å‡½æ•°ä¼˜åŒ–

## ğŸŠ å®Œæˆï¼

æ‰€æœ‰æ•°æ®åº“è¡¨å’ŒAPIæ¥å£å·²æˆåŠŸåˆ›å»ºã€‚ç°åœ¨æ‚¨å¯ä»¥ï¼š

1. è®¾ç½®ç¯å¢ƒå˜é‡
2. éƒ¨ç½²Edge Function
3. å¼€å§‹ä½¿ç”¨API

è¯¦ç»†ä½¿ç”¨è¯´æ˜è¯·å‚è€ƒ `APIæ¥å£ä½¿ç”¨ç¤ºä¾‹.md`
