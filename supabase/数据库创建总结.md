# Supabase数据库创建总结

## 项目信息

- **项目ID**: lfjvlypknjpheycqunyk
- **项目URL**: https://lfjvlypknjpheycqunyk.supabase.co
- **创建时间**: 2025-01-24

## 已创建的表

### 1. game_api_tokens
**用途**: 存储游戏API的访问Token

**字段**:
- `id` (BIGSERIAL): 主键
- `token` (TEXT): Bearer Token
- `expiration` (BIGINT): Token过期时间戳（秒）
- `created_at` (TIMESTAMPTZ): 创建时间

**索引**:
- `idx_game_api_tokens_expiration`: 过期时间索引
- `idx_game_api_tokens_created_at`: 创建时间索引（降序）

### 2. game_api_config
**用途**: 存储游戏API配置信息

**字段**:
- `id` (BIGSERIAL): 主键
- `config_key` (VARCHAR(100)): 配置键名（唯一）
- `config_value` (TEXT): 配置值
- `description` (TEXT): 描述
- `created_at` (TIMESTAMPTZ): 创建时间
- `updated_at` (TIMESTAMPTZ): 更新时间

**默认配置**:
- `api_base_url`: https://dcyqv8f2id.com/api/v2
- `rate_limit_token`: 5 (每30秒5次)
- `rate_limit_history`: 1 (每秒1次)
- `rate_limit_rtp`: 1 (每3秒1次)

### 3. game_api_logs
**用途**: 存储游戏API调用日志

**字段**:
- `id` (BIGSERIAL): 主键
- `endpoint` (VARCHAR(255)): API端点
- `method` (VARCHAR(10)): HTTP方法
- `request_body` (JSONB): 请求体
- `response_body` (JSONB): 响应体
- `status_code` (INTEGER): HTTP状态码
- `error_message` (TEXT): 错误信息
- `execution_time_ms` (INTEGER): 执行时间（毫秒）
- `created_at` (TIMESTAMPTZ): 创建时间

**索引**:
- `idx_game_api_logs_endpoint`: 端点索引
- `idx_game_api_logs_created_at`: 创建时间索引（降序）
- `idx_game_api_logs_status_code`: 状态码索引

## 已创建的函数

### 1. get_valid_game_api_token()
**功能**: 获取有效的游戏API Token（还有5分钟有效期）

**返回**: TEXT (Token字符串)

**用法**:
```sql
SELECT get_valid_game_api_token();
```

### 2. save_game_api_token(p_token TEXT, p_expiration BIGINT)
**功能**: 保存游戏API Token

**参数**:
- `p_token`: Token字符串
- `p_expiration`: 过期时间戳（秒）

**用法**:
```sql
SELECT save_game_api_token('your_token_here', 1716257131);
```

### 3. cleanup_expired_tokens()
**功能**: 清理过期的Token

**返回**: INTEGER (删除的记录数)

**用法**:
```sql
SELECT cleanup_expired_tokens();
```

### 4. check_rate_limit(p_endpoint VARCHAR, p_limit_count INTEGER, p_time_window_seconds INTEGER)
**功能**: 检查API速率限制

**参数**:
- `p_endpoint`: API端点
- `p_limit_count`: 限制次数
- `p_time_window_seconds`: 时间窗口（秒）

**返回**: BOOLEAN (true表示未超限)

**用法**:
```sql
SELECT check_rate_limit('/auth/createtoken', 5, 30);
```

### 5. log_api_call(...)
**功能**: 记录API调用日志

**参数**:
- `p_endpoint`: API端点
- `p_method`: HTTP方法
- `p_request_body`: 请求体（JSONB，可选）
- `p_response_body`: 响应体（JSONB，可选）
- `p_status_code`: HTTP状态码（可选）
- `p_error_message`: 错误信息（可选）
- `p_execution_time_ms`: 执行时间（毫秒，可选）

**返回**: BIGINT (日志ID)

**用法**:
```sql
SELECT log_api_call(
  '/game/launch-url',
  'POST',
  '{"vendorCode": "casino-evolution"}'::jsonb,
  '{"success": true}'::jsonb,
  200,
  NULL,
  150
);
```

## 已创建的视图

### 1. game_api_token_status
**功能**: 显示Token状态

**字段**:
- `id`: Token ID
- `status`: 状态（valid/expiring_soon/expired）
- `expiration`: 过期时间戳
- `seconds_until_expiry`: 距离过期的秒数
- `created_at`: 创建时间

**用法**:
```sql
SELECT * FROM game_api_token_status;
```

### 2. game_api_stats
**功能**: API统计信息

**字段**:
- `endpoint`: API端点
- `method`: HTTP方法
- `total_requests`: 总请求数
- `success_count`: 成功次数
- `error_count`: 错误次数
- `avg_execution_time_ms`: 平均执行时间（毫秒）
- `max_execution_time_ms`: 最大执行时间（毫秒）
- `first_request`: 首次请求时间
- `last_request`: 最后请求时间

**用法**:
```sql
SELECT * FROM game_api_stats;
```

## 安全策略（RLS）

所有表都已启用RLS（Row Level Security）：

1. **Service Role**: 可以访问所有数据（用于Edge Functions）
2. **Anonymous**: 
   - 可以读取配置（game_api_config）
   - 可以插入日志（game_api_logs）

## 迁移记录

已执行的迁移：
1. ✅ create_game_api_tokens_table
2. ✅ create_game_api_config_table
3. ✅ create_game_api_logs_table
4. ✅ create_api_functions
5. ✅ create_rls_policies
6. ✅ create_helper_views
7. ✅ create_api_rate_limit_function

## 下一步

1. **部署Edge Function**: 使用 `supabase functions deploy game-api`
2. **设置环境变量**: 在Supabase Dashboard中设置GAME_API_CLIENT_ID和GAME_API_CLIENT_SECRET
3. **测试API**: 使用Edge Function测试各个端点
4. **监控**: 使用game_api_stats视图监控API使用情况

## 查询示例

### 查看当前有效的Token
```sql
SELECT * FROM game_api_token_status WHERE status = 'valid';
```

### 查看API调用统计
```sql
SELECT * FROM game_api_stats ORDER BY total_requests DESC;
```

### 查看最近的错误日志
```sql
SELECT * FROM game_api_logs 
WHERE status_code >= 400 
ORDER BY created_at DESC 
LIMIT 10;
```

### 清理7天前的日志
```sql
DELETE FROM game_api_logs 
WHERE created_at < NOW() - INTERVAL '7 days';
```

## 注意事项

1. **Token管理**: Token会自动缓存，Edge Function会自动刷新
2. **日志清理**: 建议定期清理旧日志，避免数据库过大
3. **速率限制**: 使用check_rate_limit函数在Edge Function中实现速率限制
4. **监控**: 定期查看game_api_stats视图，了解API使用情况
