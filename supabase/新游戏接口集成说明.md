# 新游戏接口集成说明

## 概述

已将新游戏接口（API v2.15.2）集成到前端项目中。现在可以通过配置选择使用新游戏接口或旧游戏接口。

## 文件说明

### 1. 新游戏接口服务
- **文件**: `src/lib/api/newGameApi.ts`
- **说明**: 封装了所有新游戏接口的API调用方法
- **功能**: 
  - 获取供应商列表
  - 获取游戏列表
  - 创建游戏会话
  - 用户余额管理
  - 投注历史查询
  - RTP设置等

### 2. 游戏API更新
- **文件**: `src/lib/api/game.ts`
- **说明**: 更新了 `getGameUrl` 函数，支持使用新游戏接口
- **功能**: 
  - 自动检测是否使用新接口
  - 如果新接口失败，自动回退到旧接口
  - 支持平台代码映射

## 使用方法

### 启用新游戏接口

有两种方式启用新游戏接口：

#### 方式1: 环境变量（推荐）

在项目根目录的 `.env` 文件中添加：

```env
VITE_USE_NEW_GAME_API=true
```

#### 方式2: localStorage

在浏览器控制台执行：

```javascript
localStorage.setItem('use_new_game_api', 'true');
```

### 禁用新游戏接口

#### 方式1: 环境变量

在 `.env` 文件中设置：

```env
VITE_USE_NEW_GAME_API=false
```

或删除该环境变量。

#### 方式2: localStorage

在浏览器控制台执行：

```javascript
localStorage.removeItem('use_new_game_api');
```

## 平台代码映射

新游戏接口使用 `vendorCode` 而不是 `api_code`。代码中已经实现了自动映射：

| 旧接口代码 | 新接口vendorCode | 说明 |
|----------|-----------------|------|
| AG | casino-evolution | Evolution真人娱乐场 |
| BBIN | casino-evolution | BBIN（示例） |
| PT | slot-pragmatic | Pragmatic老虎机 |
| CQ9 | slot-cq9 | CQ9老虎机 |
| PG | slot-pg | PG老虎机 |
| JDB | slot-jdb | JDB老虎机 |

**注意**: 以上映射是示例，需要根据实际的供应商列表进行调整。

## 新游戏接口API端点

所有新游戏接口通过后端API代理调用：

- **基础URL**: `https://api.xpj66666.com/api/game-api`（或通过环境变量配置）
- **认证**: 使用Bearer Token（从localStorage获取）

### 主要接口

1. **获取供应商列表**: `GET /vendors/list`
2. **获取游戏列表**: `POST /games/list`
3. **创建游戏会话**: `POST /game/session`
4. **获取用户余额**: `POST /game/users/balance`
5. **存款（转入游戏）**: `POST /game/users/deposit`
6. **提款（从游戏转出）**: `POST /game/users/withdraw`
7. **获取投注历史**: `POST /betting/history`
8. **获取投注历史（按日期）**: `POST /betting/history/by-date-v2`

更多接口请参考 `src/lib/api/newGameApi.ts` 文件。

## 使用示例

### 获取供应商列表

```typescript
import { newGameApiService } from '@/lib/api/newGameApi';

const vendors = await newGameApiService.getVendorsList();
console.log('供应商列表:', vendors);
```

### 获取游戏列表

```typescript
import { newGameApiService } from '@/lib/api/newGameApi';

const games = await newGameApiService.getGamesList('casino-evolution', 'zh');
console.log('游戏列表:', games);
```

### 创建游戏会话

```typescript
import { newGameApiService } from '@/lib/api/newGameApi';

const session = await newGameApiService.createGameSession(
  'casino-evolution',  // vendorCode
  'lobby',             // gameCode
  'user123',           // userId
  'zh',                // language
  false                // isMobile
);
console.log('游戏URL:', session.message.gameUrl);
```

## 后端配置

确保后端已经配置了新游戏接口：

1. **系统配置**: 在管理后台配置以下项：
   - `new_game_api_domain`: 新游戏接口域名（如：`https://dcyqv8f2id.com/api/v2`）
   - `new_game_api_client_id`: 客户端ID（如：`7072205891`）
   - `new_game_api_client_secret`: 客户端密钥

2. **API路由**: 确保后端已配置 `/api/game-api/*` 路由，并指向 `NewGameApiController`

## 注意事项

1. **用户ID**: 新游戏接口需要用户ID，代码会自动从localStorage或API获取
2. **平台映射**: 如果某个平台在新接口中不存在，需要更新 `mapApiCodeToVendorCode` 函数
3. **错误处理**: 如果新接口调用失败，会自动回退到旧接口
4. **语言代码**: 默认使用 `zh`，可以从 `localStorage.getItem('ly_lang')` 获取

## 调试

### 查看日志

启用新游戏接口后，控制台会显示相关日志：

- `🎮 使用新游戏接口获取游戏URL` - 表示正在使用新接口
- `🎮 新游戏接口参数:` - 显示请求参数
- `❌ 新游戏接口调用失败:` - 表示新接口调用失败
- `🔄 回退到旧游戏接口` - 表示回退到旧接口

### 检查配置

在浏览器控制台执行：

```javascript
// 检查是否启用新接口
console.log('使用新游戏接口:', localStorage.getItem('use_new_game_api'));

// 检查环境变量（需要在代码中打印）
console.log('VITE_USE_NEW_GAME_API:', import.meta.env.VITE_USE_NEW_GAME_API);
```

## 迁移步骤

1. **测试环境**: 先在测试环境启用新接口，验证功能正常
2. **平台映射**: 根据实际供应商列表，更新平台代码映射
3. **用户ID**: 确保用户ID获取逻辑正确
4. **生产环境**: 确认无误后，在生产环境启用

## 相关文件

- `src/lib/api/newGameApi.ts` - 新游戏接口服务
- `src/lib/api/game.ts` - 游戏API（已更新）
- `src/lib/api/index.ts` - API统一导出（已更新）

## 技术支持

如有问题，请检查：
1. 后端API是否正常
2. 用户是否已登录
3. 平台代码映射是否正确
4. 浏览器控制台的错误日志
