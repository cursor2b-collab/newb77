# 新游戏接口更新说明

## 更新日期
2025年1月

## 客户端凭据
- **客户端ID**: `7072205891`
- **客户端密钥**: `DM1VQGKngVonjipb0LlJ7k4YQItIRLp4`
- **API基础URL**: `https://dcyqv8f2id.com/api/v2`

## 已实现的接口

### 1. 认证相关
- ✅ 2.1 创建令牌 (`/auth/createtoken`)
- ✅ 1.3 API状态检查 (`/status`)

### 2. 游戏信息相关
- ✅ 2.2 供应商列表 (`/vendors/list`)
- ✅ 2.3 游戏列表 (`/games/list`)
- ✅ 2.4 迷你游戏列表 (`/games/mini/list`)
- ✅ 2.5 游戏详情 (`/game/detail`)
- ✅ 2.6 获取启动URL (`/game/launch-url`)

### 3. 用户管理相关
- ✅ 2.11 创建用户 (`/user/create`)
- ✅ 2.12 余额 (`/user/balance`)
- ✅ 2.13 存款 (`/user/deposit`)
- ✅ 2.14 提款 (`/user/withdraw`)
- ✅ 2.15 全部提款 (`/user/withdraw-all`)
- ✅ 2.16 获取用户余额日志 (`/user/balance-history`) - **新增**

### 4. 投注历史相关
- ✅ 2.8 获取投注历史（按ID） (`/betting/history/by-id`)
- ✅ 2.9 获取交易历史（按ID） (`/transaction/history/by-id`) - **新增**
- ✅ 2.21 获取投注历史V2（按日期） (`/betting/history/by-date-v2`)
- ✅ 2.22 获取投注详情页面URL (`/betting/history/detail`)

### 5. RTP管理相关
- ✅ 2.17 设置用户RTP (`/game/user/set-rtp`)
- ✅ 2.18 获取用户RTP (`/game/user/get-rtp`)
- ✅ 2.19 重置用户RTP (`/game/users/reset-rtp`) - **新增**
- ✅ 2.20 设置用户RTP（批量） (`/game/users/batch-rtp`)

### 6. 代理相关
- ✅ 2.10 获取代理余额 (`/agent/balance`)

## 新增功能

### 1. 重置用户RTP接口 (2.19)
- **路径**: `POST /game/users/reset-rtp`
- **功能**: 为所有用户设置统一的RTP值
- **参数**: 
  - `vendorCode`: 供应商代码
  - `rtp`: RTP值（30-99）

### 2. 获取交易历史接口 (2.9)
- **路径**: `POST /transaction/history/by-id`
- **功能**: 根据历史记录ID获取交易历史详情
- **参数**: 
  - `id`: 历史记录ID

### 3. 获取用户余额日志接口 (2.16)
- **路径**: `POST /user/balance-history`
- **功能**: 根据订单号获取用户余额历史记录
- **参数**: 
  - `orderNo`: 订单号

## 代码更新位置

### 后端 (Edge Function)
- **文件**: `tongmeng-main/supabase/functions/game-api/index.ts`
- **更新内容**:
  - 添加 `resetUserRtp()` 方法
  - 添加 `getTransactionHistoryById()` 方法
  - 添加 `getUserBalanceHistory()` 方法
  - 添加对应的路由处理

### 前端服务
- **文件**: `stake-vue/src/services/gameApiService.js`
- **更新内容**:
  - 添加 `resetUserRtp()` 方法
  - 添加 `getTransactionHistoryById()` 方法
  - 添加 `getUserBalanceHistory()` 方法

## 配置说明

### Supabase环境变量
需要在Supabase项目中设置以下环境变量：

```bash
GAME_API_CLIENT_ID=7072205891
GAME_API_CLIENT_SECRET=DM1VQGKngVonjipb0LlJ7k4YQItIRLp4
GAME_API_BASE_URL=https://dcyqv8f2id.com/api/v2
```

### 设置方法

#### 方法1: 使用Supabase CLI
```bash
supabase secrets set GAME_API_CLIENT_ID=7072205891
supabase secrets set GAME_API_CLIENT_SECRET=DM1VQGKngVonjipb0LlJ7k4YQItIRLp4
supabase secrets set GAME_API_BASE_URL=https://dcyqv8f2id.com/api/v2
```

#### 方法2: 通过Supabase Dashboard
1. 访问项目设置页面
2. 进入 Edge Functions > Secrets
3. 添加上述三个环境变量
4. 保存并重新部署函数

## API速率限制

根据新接口文档，以下接口有速率限制：

1. **创建令牌** (`/auth/createtoken`)
   - 限制: 5次/30秒

2. **获取投注历史V2** (`/betting/history/by-date-v2`)
   - 限制: 1次/秒

3. **批量设置用户RTP** (`/game/users/batch-rtp`)
   - 限制: 1次/3秒

代码中已实现速率限制检查，使用数据库函数 `check_rate_limit` 进行验证。

## 测试建议

1. **测试API状态**
   ```bash
   curl https://your-project.supabase.co/functions/v1/game-api/status
   ```

2. **测试获取供应商列表**
   ```bash
   curl -X GET https://your-project.supabase.co/functions/v1/game-api/vendors/list \
     -H "Authorization: Bearer YOUR_JWT_TOKEN"
   ```

3. **测试新接口**
   - 重置用户RTP
   - 获取交易历史
   - 获取用户余额日志

## 注意事项

1. **环境变量**: 确保在Supabase项目中正确设置了所有必需的环境变量
2. **速率限制**: 注意遵守API速率限制，避免请求被拒绝
3. **Token管理**: Token会自动缓存和刷新，无需手动管理
4. **错误处理**: 所有接口都包含完整的错误处理机制

## 相关文档

- 新游戏接口文档: `新游戏接口文档.txt`
- 配置指南: `supabase/配置游戏API凭据.md`
- API使用示例: `supabase/API接口使用示例.md`
